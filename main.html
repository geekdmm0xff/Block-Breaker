<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Block Breaker</title>
    <style>
        #id-canvas {
            border: 1px solid black;
            width: 400px;
            height: 400px;
        }
    </style>

    <script src="Utils.js"></script>
    <script src="Paddle.js"></script>
    <script src="Ball.js"></script>
    <script src="Block.js"></script>
    <script src="Game.js"></script>
    <script src="Utils.js"></script>
    <script src="Resource/Levels.js"></script>
</head>
<body>
    <canvas id="id-canvas" width="400" height="400"></canvas>

    <script>
        var loadLevels = function (level) {
            level -= 1
            var list = levels[level]
            var blocks = []
            for (var i = 0; i < list.length; i++) {
                var e = list[i]
                var b = Block(e)
                log(b)
                blocks.push(b)
            }
            return blocks
        }
        
        var __main = function() {
            // canvas
            var game = Game(30)

            var paddle = Paddle()
            var ball = Ball()


            var blockList = loadLevels(1)

            // 注册函数和声明函数是两回事!
            game.registerAction('a', function () {
                paddle.moveLeft()
            })

            game.registerAction('d', function () {
                paddle.moveRight()
            })

            game.registerAction('f', function () {
                ball.fired = true
            })

            // 注册系统事件
            window.addEventListener('keydown', function (event) {
                var k = event.key
                if (k === 'p') {
                    game.pause ^= 1
                } else if ('123456789'.includes(k)) {
                    blockList = loadLevels(Number(k))
                }
            })

            game.update = function () {
                // 暂停检测
                if (game.pause) {
                    return
                }

                ball.move()

                // 碰撞检测
                if (paddle.collide(ball)) {
                    ball.bounce()
                }

                for (var i = 0; i < blockList.length; i++) {
                    var b = blockList[i]
                    if (b.collide(ball)) {
                        b.kill()
                        ball.bounce()
                    }
                }
            }

            game.draw = function () {
                game.drawImage(paddle)
                game.drawImage(ball)

                for (var i = 0; i < blockList.length; i++) {
                    var b = blockList[i]
                    if (b.alive) {
                        game.drawImage(b)
                    }
                }
            }
        }
        __main()
    </script>
</body>
</html>
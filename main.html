<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Block Breaker</title>
    <style>
        #id-canvas {
            border: 1px solid black;
            width: 400px;
            height: 400px;
        }
    </style>

    <script src="Utils.js"></script>
    <script src="Paddle.js"></script>
    <script src="Ball.js"></script>
    <script src="Block.js"></script>
    <script src="Game.js"></script>
    <script src="Utils.js"></script>
    <script src="Resource/Levels.js"></script>
</head>
<body>
    <canvas id="id-canvas" width="400" height="400"></canvas>
    <div>
        <label>FPS:</label>
        <input id="id-speed-input" type="range" min="1">
        <span id="id-speed-span">50</span>
    </div>
    <script>
        var loadLevels = function (level, game) {
            log(game)
            level -= 1
            var list = levels[level]
            var blocks = []
            for (var i = 0; i < list.length; i++) {
                var e = list[i]
                var b = Block(e, game)
                blocks.push(b)
            }
            return blocks
        }

        var game = null
        var __main = function() {
            // canvas
            game = Game(30, {
                block: 'Resource/block.png',
                ball: 'Resource/ball.png',
                paddle: 'Resource/paddle.png',
            })

            var paddle = null
            var ball = null

            var blockList = null

            // image 加载完回调
            game.config = function () {
                log(game)
                paddle = Paddle(game)
                ball = Ball(game)
                blockList = loadLevels(1, game)
            }

            // 注册函数和声明函数是两回事!
            game.registerAction('a', function () {
                paddle.moveLeft()
            })

            game.registerAction('d', function () {
                paddle.moveRight()
            })

            game.registerAction('f', function () {
                ball.fired = true
            })

            game.enableDebug = true
            game.debugCallback(function () {
                // 注册系统事件
                window.addEventListener('keydown', function (event) {
                    var k = event.key
                    if (k === 'p') {
                        game.pause ^= 1
                    } else if ('123456789'.includes(k)) {
                        log(game)
                        blockList = loadLevels(Number(k), game)
                    }
                })

                // dynamic speed
                var input = document.querySelector('#id-speed-input')
                var span = document.querySelector('#id-speed-span')
                input.value = game.fps
                span.innerHTML = game.fps

                input.addEventListener('change', function (event) {
                    var v = input.value
                    span.innerHTML = v
                    game.fps = Number(v)
                })
            })

            game.update = function () {
                // 暂停检测
                if (game.pause) {
                    return
                }

                ball.move()

                // 碰撞检测
                if (paddle.collide(ball)) {
                    ball.bounce()
                }

                for (var i = 0; i < blockList.length; i++) {
                    var b = blockList[i]
                    if (b.collide(ball)) {
                        b.kill()
                        ball.bounce()
                    }
                }
            }

            game.draw = function () {
                game.drawImage(paddle)
                game.drawImage(ball)

                for (var i = 0; i < blockList.length; i++) {
                    var b = blockList[i]
                    if (b.alive) {
                        game.drawImage(b)
                    }
                }
            }
        }
        __main()
    </script>
</body>
</html>